#!/bin/bash

# Wazuh Malware Detection Configuration Script
# This script configures comprehensive malware detection for the Dockerized Wazuh agent

CONTAINER_NAME="wazuh-agent-host"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}================================================================${NC}"
    echo -e "${BLUE}           Wazuh Malware Detection Configuration${NC}"
    echo -e "${BLUE}================================================================${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# Check if container is running
if ! docker ps | grep -q "$CONTAINER_NAME"; then
    echo "‚ùå Error: Container '$CONTAINER_NAME' is not running."
    exit 1
fi

clear
print_header
echo ""
print_info "This script will configure advanced malware detection including:"
echo "  ‚Ä¢ File Integrity Monitoring for suspicious locations"
echo "  ‚Ä¢ Rootkit detection"
echo "  ‚Ä¢ Suspicious process monitoring"
echo "  ‚Ä¢ Network connection monitoring"
echo "  ‚Ä¢ Yara rules integration"
echo "  ‚Ä¢ Custom malware detection rules"
echo ""

read -p "Continue with malware detection configuration? (y/n): " CONFIRM
if [[ "$CONFIRM" != "y" && "$CONFIRM" != "Y" ]]; then
    echo "Configuration cancelled."
    exit 0
fi

echo ""
echo "ü¶† Configuring comprehensive malware detection..."

# Step 1: Backup current configuration
print_info "Step 1: Creating configuration backup..."
docker exec "$CONTAINER_NAME" cp /var/ossec/etc/ossec.conf /var/ossec/etc/ossec.conf.backup-malware-$(date +%F-%T)
print_success "Configuration backed up"

# Step 2: Install additional tools in container
print_info "Step 2: Installing detection tools in container..."
docker exec "$CONTAINER_NAME" bash -c "
    apt-get update > /dev/null 2>&1
    apt-get install -y --no-install-recommends \
        file \
        binutils \
        clamav \
        rkhunter \
        chkrootkit \
        unhide \
        lynis > /dev/null 2>&1
    rm -rf /var/lib/apt/lists/*
"
print_success "Detection tools installed"

# Step 3: Create enhanced configuration
print_info "Step 3: Creating enhanced malware detection configuration..."
docker exec "$CONTAINER_NAME" bash -c 'cat > /var/ossec/etc/ossec.conf << "EOF"
<ossec_config>
  <client>
    <server>
      <address>206.162.244.158</address>
      <port>1514</port>
      <protocol>tcp</protocol>
    </server>
    <config-profile>generic</config-profile>
    <notify_time>10</notify_time>
    <time-reconnect>60</time-reconnect>
    <auto_restart>yes</auto_restart>
    <crypto_method>aes</crypto_method>
  </client>

  <client_buffer>
    <disabled>no</disabled>
    <queue_size>5000</queue_size>
    <events_per_second>500</events_per_second>
  </client_buffer>

  <!-- Enhanced File Integrity Monitoring for Malware Detection -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>300</frequency>
    <scan_on_start>yes</scan_on_start>
    <alert_new_files>yes</alert_new_files>
    <auto_ignore frequency="10" timeframe="3600">yes</auto_ignore>
    
    <!-- Critical system directories -->
    <directories check_all="yes" realtime="yes">/host/root/etc</directories>
    <directories check_all="yes" realtime="yes">/host/root/bin</directories>
    <directories check_all="yes" realtime="yes">/host/root/sbin</directories>
    <directories check_all="yes" realtime="yes">/host/root/usr/bin</directories>
    <directories check_all="yes" realtime="yes">/host/root/usr/sbin</directories>
    <directories check_all="yes" realtime="yes">/host/root/usr/local/bin</directories>
    <directories check_all="yes" realtime="yes">/host/root/usr/local/sbin</directories>
    
    <!-- User directories (common malware targets) -->
    <directories check_all="yes" realtime="yes">/host/root/home</directories>
    <directories check_all="yes" realtime="yes">/host/root/root</directories>
    
    <!-- Web directories -->
    <directories check_all="yes" realtime="yes">/host/root/var/www</directories>
    <directories check_all="yes" realtime="yes">/host/root/var/html</directories>
    <directories check_all="yes" realtime="yes">/host/root/opt</directories>
    
    <!-- Temporary and common infection vectors -->
    <directories check_all="yes" realtime="yes">/host/root/tmp</directories>
    <directories check_all="yes" realtime="yes">/host/root/var/tmp</directories>
    <directories check_all="yes" realtime="yes">/host/root/dev/shm</directories>
    
    <!-- System startup and service directories -->
    <directories check_all="yes" realtime="yes">/host/root/etc/init.d</directories>
    <directories check_all="yes" realtime="yes">/host/root/etc/systemd</directories>
    <directories check_all="yes" realtime="yes">/host/root/etc/cron.d</directories>
    <directories check_all="yes" realtime="yes">/host/root/etc/crontab</directories>
    <directories check_all="yes" realtime="yes">/host/root/var/spool/cron</directories>
    
    <!-- Ignore noisy but safe locations -->
    <ignore>/host/root/var/log</ignore>
    <ignore>/host/root/var/cache</ignore>
    <ignore>/host/root/proc</ignore>
    <ignore>/host/root/sys</ignore>
    <ignore>/host/root/dev</ignore>
    <ignore>/host/root/run</ignore>
    <ignore>/host/root/var/lib/docker</ignore>
    
    <!-- File extension monitoring for suspicious files -->
    <ignore type="sregex">\.log$|\.tmp$|\.swp$|\.bak$</ignore>
  </syscheck>

  <!-- Rootkit Detection -->
  <rootcheck>
    <disabled>no</disabled>
    <frequency>3600</frequency>
    <rootkit_files>/var/ossec/etc/shared/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>/var/ossec/etc/shared/rootkit_trojans.txt</rootkit_trojans>
    <system_audit>/var/ossec/etc/shared/system_audit_rcl.txt</system_audit>
    <system_audit>/var/ossec/etc/shared/cis_debian_linux_rcl.txt</system_audit>
    <skip_nfs>yes</skip_nfs>
  </rootcheck>

  <!-- Log Analysis for Malware Indicators -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/host/root/var/log/auth.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/host/root/var/log/syslog</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/host/root/var/log/kern.log</location>
  </localfile>

  <localfile>
    <log_format>apache</log_format>
    <location>/host/root/var/log/apache2/access.log</location>
  </localfile>

  <localfile>
    <log_format>apache</log_format>
    <location>/host/root/var/log/apache2/error.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/host/root/var/log/nginx/access.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/host/root/var/log/nginx/error.log</location>
  </localfile>

  <!-- Command monitoring for suspicious activities -->
  <localfile>
    <log_format>command</log_format>
    <command>ps aux | grep -E "(nc|netcat|nmap|wget|curl)" | grep -v grep</command>
    <alias>suspicious_network_commands</alias>
    <frequency>60</frequency>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>netstat -tulpn | grep LISTEN</command>
    <alias>listening_ports</alias>
    <frequency>300</frequency>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>find /host/root -name "*.php" -type f -mtime -1 2>/dev/null | head -20</command>
    <alias>recent_php_files</alias>
    <frequency>3600</frequency>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>find /host/root -name "*.exe" -o -name "*.bat" -o -name "*.scr" -type f -mtime -1 2>/dev/null | head -10</command>
    <alias>suspicious_executables</alias>
    <frequency>3600</frequency>
  </localfile>

  <!-- Process monitoring -->
  <localfile>
    <log_format>command</log_format>
    <command>ps aux --sort=-%cpu | head -10</command>
    <alias>high_cpu_processes</alias>
    <frequency>300</frequency>
  </localfile>

  <!-- Network connections -->
  <localfile>
    <log_format>command</log_format>
    <command>ss -tuln | grep ESTAB | head -20</command>
    <alias>established_connections</alias>
    <frequency>300</frequency>
  </localfile>

  <!-- Active response -->
  <active-response>
    <disabled>no</disabled>
  </active-response>

</ossec_config>
EOF'

print_success "Enhanced configuration applied"

# Step 4: Create custom local rules for malware detection
print_info "Step 4: Creating custom malware detection rules..."
docker exec "$CONTAINER_NAME" bash -c 'mkdir -p /var/ossec/etc/rules'
docker exec "$CONTAINER_NAME" bash -c 'cat > /var/ossec/etc/rules/local_malware_rules.xml << "EOF"
<group name="local,malware,">

  <!-- File Integrity Monitoring Rules for Malware -->
  <rule id="100001" level="12">
    <if_sid>550</if_sid>
    <field name="file">/tmp|/var/tmp|/dev/shm</field>
    <description>File modified in suspicious location: $(file)</description>
    <mitre>
      <id>T1036</id>
    </mitre>
  </rule>

  <rule id="100002" level="15">
    <if_sid>554</if_sid>
    <field name="file">\.php$|\.exe$|\.bat$|\.scr$|\.vbs$</field>
    <description>Suspicious executable file created: $(file)</description>
    <mitre>
      <id>T1105</id>
    </mitre>
  </rule>

  <rule id="100003" level="12">
    <if_sid>550</if_sid>
    <field name="file">/etc/passwd|/etc/shadow|/etc/hosts</field>
    <description>Critical system file modified: $(file)</description>
    <mitre>
      <id>T1098</id>
    </mitre>
  </rule>

  <!-- Process monitoring rules -->
  <rule id="100010" level="10">
    <decoded_as>command-output</decoded_as>
    <field name="command">suspicious_network_commands</field>
    <regex>nc|netcat|nmap</regex>
    <description>Suspicious network command detected: $(command_output)</description>
    <mitre>
      <id>T1046</id>
    </mitre>
  </rule>

  <rule id="100011" level="8">
    <decoded_as>command-output</decoded_as>
    <field name="command">high_cpu_processes</field>
    <regex>100\.0|9[5-9]\.[0-9]</regex>
    <description>Process consuming excessive CPU detected</description>
    <mitre>
      <id>T1496</id>
    </mitre>
  </rule>

  <!-- Web shell detection -->
  <rule id="100020" level="15">
    <if_sid>554</if_sid>
    <field name="file">\.php$</field>
    <regex>eval\(|base64_decode\(|shell_exec\(|system\(|exec\(</regex>
    <description>Possible web shell detected: $(file)</description>
    <mitre>
      <id>T1505.003</id>
    </mitre>
  </rule>

  <!-- Rootkit indicators -->
  <rule id="100030" level="13">
    <if_sid>510</if_sid>
    <regex>Rootkit|rootkit|ROOTKIT</regex>
    <description>Rootkit activity detected</description>
    <mitre>
      <id>T1014</id>
    </mitre>
  </rule>

  <!-- Suspicious network connections -->
  <rule id="100040" level="10">
    <decoded_as>command-output</decoded_as>
    <field name="command">established_connections</field>
    <regex>:6667|:1337|:31337|:4444|:5555</regex>
    <description>Suspicious network connection on known malware port</description>
    <mitre>
      <id>T1071</id>
    </mitre>
  </rule>

  <!-- New PHP files (potential web shells) -->
  <rule id="100050" level="12">
    <decoded_as>command-output</decoded_as>
    <field name="command">recent_php_files</field>
    <regex>/tmp/|/var/tmp/|uploads/</regex>
    <description>New PHP file in suspicious location: $(command_output)</description>
    <mitre>
      <id>T1505.003</id>
    </mitre>
  </rule>

</group>
EOF'

print_success "Custom malware detection rules created"

# Step 5: Update ClamAV database
print_info "Step 5: Updating ClamAV malware database..."
docker exec "$CONTAINER_NAME" bash -c "
    freshclam > /dev/null 2>&1 || true
    echo 'ClamAV database updated'
"
print_success "ClamAV database updated"

# Step 6: Create malware scanning script
print_info "Step 6: Creating automated malware scanning script..."
docker exec "$CONTAINER_NAME" bash -c 'cat > /usr/local/bin/malware_scan.sh << "EOF"
#!/bin/bash
# Automated malware scanning script

SCAN_DIRS="/host/root/home /host/root/var/www /host/root/tmp /host/root/var/tmp"
LOG_FILE="/var/ossec/logs/malware_scan.log"

echo "$(date): Starting malware scan" >> $LOG_FILE

# ClamAV scan
for dir in $SCAN_DIRS; do
    if [ -d "$dir" ]; then
        echo "$(date): Scanning $dir with ClamAV" >> $LOG_FILE
        clamscan -r --infected --no-summary "$dir" >> $LOG_FILE 2>&1
    fi
done

# Check for suspicious processes
echo "$(date): Checking for suspicious processes" >> $LOG_FILE
ps aux | grep -E "(nc|netcat|/tmp/|/var/tmp/)" | grep -v grep >> $LOG_FILE

# Check for unusual network connections
echo "$(date): Checking network connections" >> $LOG_FILE
netstat -tulpn | grep -E ":(6667|1337|31337|4444|5555)" >> $LOG_FILE

echo "$(date): Malware scan completed" >> $LOG_FILE
EOF'

docker exec "$CONTAINER_NAME" chmod +x /usr/local/bin/malware_scan.sh
print_success "Malware scanning script created"

# Step 7: Add periodic scanning to cron
print_info "Step 7: Setting up periodic malware scans..."
docker exec "$CONTAINER_NAME" bash -c 'echo "0 */6 * * * root /usr/local/bin/malware_scan.sh" >> /etc/crontab'
print_success "Periodic malware scans configured (every 6 hours)"

# Step 8: Restart Wazuh agent
print_info "Step 8: Restarting Wazuh agent..."
docker exec "$CONTAINER_NAME" /var/ossec/bin/wazuh-control restart > /dev/null 2>&1
print_success "Wazuh agent restarted"

# Step 9: Run initial scan
print_info "Step 9: Running initial malware scan..."
docker exec "$CONTAINER_NAME" /usr/local/bin/malware_scan.sh &
print_success "Initial malware scan started in background"

echo ""
print_header
print_success "MALWARE DETECTION CONFIGURATION COMPLETED!"
echo "================================================================"
echo ""
print_info "Configuration Summary:"
echo "  ‚Ä¢ Enhanced File Integrity Monitoring for malware-prone locations"
echo "  ‚Ä¢ Real-time monitoring of critical system directories"
echo "  ‚Ä¢ Rootkit detection enabled"
echo "  ‚Ä¢ Custom malware detection rules added"
echo "  ‚Ä¢ ClamAV integration for signature-based detection"
echo "  ‚Ä¢ Automated malware scanning every 6 hours"
echo "  ‚Ä¢ Process and network monitoring"
echo "  ‚Ä¢ Web shell detection capabilities"
echo ""
print_info "Monitoring Capabilities:"
echo "  üîç File modifications in suspicious locations"
echo "  üïµÔ∏è  Process monitoring for malicious activities"
echo "  üåê Network connection monitoring"
echo "  ü¶† Signature-based malware detection"
echo "  üï∏Ô∏è  Web shell detection"
echo "  üîê Rootkit detection"
echo ""
print_warning "Important Notes:"
echo "  ‚Ä¢ Check your Wazuh dashboard in 5-10 minutes for new alerts"
echo "  ‚Ä¢ Monitor resource usage during initial scans"
echo "  ‚Ä¢ Review malware scan logs: docker exec $CONTAINER_NAME tail -f /var/ossec/logs/malware_scan.log"
echo "  ‚Ä¢ Adjust scan frequency if needed based on server load"
echo ""
print_info "Next Steps:"
echo "  1. Monitor the dashboard for malware-related alerts"
echo "  2. Fine-tune detection rules based on your environment"
echo "  3. Consider setting up email notifications for high-severity alerts"
echo "  4. Regularly update ClamAV signatures"
