#!/bin/bash

# Wazuh Malware Detection Manager
# This script provides management and monitoring for all malware detection features

CONTAINER_NAME="wazuh-agent-host"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

print_header() {
    echo -e "${PURPLE}================================================================${NC}"
    echo -e "${PURPLE}           Wazuh Malware Detection Manager${NC}"
    echo -e "${PURPLE}================================================================${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Check if container is running
check_container() {
    if ! docker ps | grep -q "$CONTAINER_NAME"; then
        print_error "Container '$CONTAINER_NAME' is not running."
        exit 1
    fi
}

# Show system status
show_status() {
    echo ""
    print_info "System Status Check"
    echo "==================="
    
    # Container status
    if docker ps | grep -q "$CONTAINER_NAME"; then
        print_success "Wazuh container is running"
    else
        print_error "Wazuh container is not running"
        return
    fi
    
    # Agent status
    AGENT_STATUS=$(docker exec "$CONTAINER_NAME" /var/ossec/bin/wazuh-control status 2>/dev/null)
    if echo "$AGENT_STATUS" | grep -q "wazuh-agentd is running"; then
        print_success "Wazuh agent is running"
    else
        print_warning "Wazuh agent may not be running properly"
    fi
    
    # Check malware detection components
    echo ""
    print_info "Malware Detection Components:"
    
    # ClamAV
    if docker exec "$CONTAINER_NAME" which clamscan >/dev/null 2>&1; then
        print_success "ClamAV installed"
        CLAM_VERSION=$(docker exec "$CONTAINER_NAME" clamscan --version 2>/dev/null | head -1)
        echo "    Version: $CLAM_VERSION"
    else
        print_warning "ClamAV not found"
    fi
    
    # Yara
    if docker exec "$CONTAINER_NAME" which yara >/dev/null 2>&1; then
        print_success "Yara installed"
        YARA_VERSION=$(docker exec "$CONTAINER_NAME" yara --version 2>/dev/null)
        echo "    Version: $YARA_VERSION"
        
        # Count Yara rules
        RULE_COUNT=$(docker exec "$CONTAINER_NAME" find /var/ossec/yara-rules -name "*.yar" -o -name "*.yara" | wc -l)
        echo "    Rules: $RULE_COUNT files"
    else
        print_warning "Yara not found"
    fi
    
    # Other tools
    for tool in rkhunter chkrootkit unhide; do
        if docker exec "$CONTAINER_NAME" which "$tool" >/dev/null 2>&1; then
            print_success "$tool installed"
        else
            print_warning "$tool not found"
        fi
    done
    
    echo ""
    print_info "Recent Scan Activity:"
    
    # Check recent scans
    if docker exec "$CONTAINER_NAME" test -f /var/ossec/logs/malware_scan.log; then
        LAST_MALWARE_SCAN=$(docker exec "$CONTAINER_NAME" tail -1 /var/ossec/logs/malware_scan.log | grep "completed" | cut -d: -f1-2)
        if [ ! -z "$LAST_MALWARE_SCAN" ]; then
            echo "    Last malware scan: $LAST_MALWARE_SCAN"
        fi
    fi
    
    if docker exec "$CONTAINER_NAME" test -f /var/ossec/logs/yara_scan.log; then
        LAST_YARA_SCAN=$(docker exec "$CONTAINER_NAME" tail -1 /var/ossec/logs/yara_scan.log | grep "completed" | cut -d: -f1-2)
        if [ ! -z "$LAST_YARA_SCAN" ]; then
            echo "    Last Yara scan: $LAST_YARA_SCAN"
        fi
    fi
}

# View recent alerts
show_alerts() {
    echo ""
    print_info "Recent Malware Alerts (Last 24 hours)"
    echo "======================================"
    
    # Show recent malware-related alerts from ossec.log
    docker exec "$CONTAINER_NAME" grep -i "malware\|yara\|clam\|rootkit\|suspicious" /var/ossec/logs/ossec.log 2>/dev/null | tail -20 | while read line; do
        if echo "$line" | grep -qi "alert\|critical\|warning"; then
            echo -e "${RED}üö® $line${NC}"
        else
            echo "   $line"
        fi
    done
    
    echo ""
    print_info "Yara Detection Summary:"
    if docker exec "$CONTAINER_NAME" test -f /var/ossec/logs/yara_scan.log; then
        YARA_ALERTS=$(docker exec "$CONTAINER_NAME" grep -c "ALERT" /var/ossec/logs/yara_scan.log 2>/dev/null || echo "0")
        echo "    Total Yara alerts: $YARA_ALERTS"
        
        if [ "$YARA_ALERTS" -gt 0 ]; then
            print_warning "Recent Yara detections found!"
            docker exec "$CONTAINER_NAME" grep "ALERT" /var/ossec/logs/yara_scan.log | tail -5
        fi
    fi
}

# Run manual scan
run_manual_scan() {
    echo ""
    print_info "Starting Manual Malware Scan"
    echo "============================="
    
    PS3="Select scan type: "
    options=("Full Scan (ClamAV + Yara)" "ClamAV Only" "Yara Only" "Quick Scan" "Cancel")
    select opt in "${options[@]}"; do
        case $opt in
            "Full Scan (ClamAV + Yara)")
                print_info "Running comprehensive malware scan..."
                docker exec "$CONTAINER_NAME" /usr/local/bin/malware_scan.sh &
                docker exec "$CONTAINER_NAME" /usr/local/bin/yara_scan.sh &
                print_success "Full scan started in background"
                echo "Monitor progress with: docker logs -f $CONTAINER_NAME"
                break
                ;;
            "ClamAV Only")
                print_info "Running ClamAV scan..."
                docker exec "$CONTAINER_NAME" /usr/local/bin/malware_scan.sh &
                print_success "ClamAV scan started in background"
                break
                ;;
            "Yara Only")
                print_info "Running Yara scan..."
                docker exec "$CONTAINER_NAME" /usr/local/bin/yara_scan.sh &
                print_success "Yara scan started in background"
                break
                ;;
            "Quick Scan")
                print_info "Running quick scan on high-risk directories..."
                docker exec "$CONTAINER_NAME" bash -c "
                    echo 'Quick scan started' >> /var/ossec/logs/ossec.log
                    clamscan -r --infected /host/root/tmp /host/root/var/tmp 2>/dev/null
                    yara -r /var/ossec/yara-rules/custom_web_malware.yar /host/root/var/www 2>/dev/null
                    echo 'Quick scan completed' >> /var/ossec/logs/ossec.log
                " &
                print_success "Quick scan started"
                break
                ;;
            "Cancel")
                echo "Scan cancelled"
                break
                ;;
            *) echo "Invalid option $REPLY";;
        esac
    done
}

# Update signatures
update_signatures() {
    echo ""
    print_info "Updating Malware Signatures"
    echo "============================"
    
    # Update ClamAV
    print_info "Updating ClamAV signatures..."
    if docker exec "$CONTAINER_NAME" freshclam > /dev/null 2>&1; then
        print_success "ClamAV signatures updated"
    else
        print_warning "ClamAV signature update failed"
    fi
    
    # Update Yara rules
    print_info "Updating Yara rules..."
    if docker exec "$CONTAINER_NAME" /usr/local/bin/update_yara_rules.sh > /dev/null 2>&1; then
        print_success "Yara rules updated"
    else
        print_warning "Yara rules update failed"
    fi
    
    print_success "Signature update completed"
}

# View configuration
view_config() {
    echo ""
    print_info "Current Malware Detection Configuration"
    echo "======================================"
    
    echo ""
    echo "üìÅ Monitored Directories:"
    docker exec "$CONTAINER_NAME" grep -A 20 "<syscheck>" /var/ossec/etc/ossec.conf | grep "<directories" | sed 's/.*<directories[^>]*>//g' | sed 's/<\/directories>//g' | sort | uniq
    
    echo ""
    echo "üïê Scan Schedule:"
    docker exec "$CONTAINER_NAME" cat /etc/crontab | grep -E "(malware_scan|yara_scan|update_yara)"
    
    echo ""
    echo "üìã Active Monitoring:"
    docker exec "$CONTAINER_NAME" grep -c "<localfile>" /var/ossec/etc/ossec.conf
    echo "   Log files monitored: $(docker exec "$CONTAINER_NAME" grep -c "<localfile>" /var/ossec/etc/ossec.conf)"
    
    echo ""
    echo "üéØ Custom Rules:"
    if docker exec "$CONTAINER_NAME" test -f /var/ossec/etc/rules/local_malware_rules.xml; then
        RULE_COUNT=$(docker exec "$CONTAINER_NAME" grep -c "<rule id=" /var/ossec/etc/rules/local_malware_rules.xml)
        echo "   Custom malware rules: $RULE_COUNT"
    fi
}

# View logs
view_logs() {
    echo ""
    print_info "Log Viewer"
    echo "=========="
    
    PS3="Select log to view: "
    options=("Wazuh Agent Log" "Malware Scan Log" "Yara Scan Log" "Live Tail (Ctrl+C to exit)" "Back")
    select opt in "${options[@]}"; do
        case $opt in
            "Wazuh Agent Log")
                docker exec "$CONTAINER_NAME" tail -50 /var/ossec/logs/ossec.log
                break
                ;;
            "Malware Scan Log")
                if docker exec "$CONTAINER_NAME" test -f /var/ossec/logs/malware_scan.log; then
                    docker exec "$CONTAINER_NAME" tail -50 /var/ossec/logs/malware_scan.log
                else
                    print_warning "Malware scan log not found"
                fi
                break
                ;;
            "Yara Scan Log")
                if docker exec "$CONTAINER_NAME" test -f /var/ossec/logs/yara_scan.log; then
                    docker exec "$CONTAINER_NAME" tail -50 /var/ossec/logs/yara_scan.log
                else
                    print_warning "Yara scan log not found"
                fi
                break
                ;;
            "Live Tail (Ctrl+C to exit)")
                print_info "Showing live log feed (Ctrl+C to exit)..."
                docker exec -it "$CONTAINER_NAME" tail -f /var/ossec/logs/ossec.log
                break
                ;;
            "Back")
                break
                ;;
            *) echo "Invalid option $REPLY";;
        esac
    done
}

# Main menu
main_menu() {
    clear
    print_header
    echo ""
    
    PS3="Please select an option: "
    options=("System Status" "View Recent Alerts" "Run Manual Scan" "Update Signatures" "View Configuration" "View Logs" "Exit")
    select opt in "${options[@]}"; do
        case $opt in
            "System Status")
                show_status
                echo ""
                read -p "Press Enter to continue..."
                main_menu
                ;;
            "View Recent Alerts")
                show_alerts
                echo ""
                read -p "Press Enter to continue..."
                main_menu
                ;;
            "Run Manual Scan")
                run_manual_scan
                echo ""
                read -p "Press Enter to continue..."
                main_menu
                ;;
            "Update Signatures")
                update_signatures
                echo ""
                read -p "Press Enter to continue..."
                main_menu
                ;;
            "View Configuration")
                view_config
                echo ""
                read -p "Press Enter to continue..."
                main_menu
                ;;
            "View Logs")
                view_logs
                echo ""
                read -p "Press Enter to continue..."
                main_menu
                ;;
            "Exit")
                echo ""
                print_success "Goodbye!"
                break
                ;;
            *) echo "Invalid option $REPLY";;
        esac
    done
}

# Check container and start
check_container
main_menu
